Now, with preferences and choices defined, and the linkage between the two established, we need to transfer these concepts into math for analytic studies.
This is exactly why utility functions are introduced: to assign a number and rank the elements in $X$ according to preferences.

\begin{definition}{utility function $u(\cdot)$}{utility}
    A function $u:X\rightarrow\mathbb{R}$ is a \textit{utility function representing relation} $\succsim$ if $\forall x,y\in X,x\succsim y\Leftrightarrow u(x)\geq u(y)$
\end{definition}

Notice that a utility function representing a preference relation $\succsim$ is NOT unique. \textbf{Rank-preserving} is the only requirement, hence, any 
strictly increasing function $f:\mathbb{R}\rightarrow\mathbb{R},v(x)=f(u(x))$ will also represent $\succsim$ as $u(\cdot)$. The logic is quite straight forward: for $x,y\in X$ and $u(\cdot)$ represents $\succsim$, then $x\succsim y \Leftrightarrow u(x)\geq u(y)$, for a strictly increasing $f(\cdot)$, $u(x)\geq u(y)\Leftrightarrow f(u(x))\geq f(u(y))\Leftrightarrow v(x)\geq v(y)$, hence $v(\cdot)$ represents $\succsim$ as well.
The major requirement here is \textbf{strictly increasing $f(\cdot)$}.

Two concepts to keep in mind:
\begin{enumerate}
    \item \textbf{Ordinal} properties of utility functions: the \textbf{invariant} properties of $u(\cdot)$ across all of its strictly increasing transformations $f(u(\cdot))$. Ranking (i.e. the preference represented by utility functions) is ordinal.
    \item \textbf{Cardinal} properties of utility functions: the \textbf{variant} properties of $u(\cdot)$ across all of its strictly increasing transformation $f(u(\cdot))$. Numerical values associated with the alternatives in $X$ (i.e. the magnitude of the differences between alternatives) is cardinal.
\end{enumerate}

The numerical value, or even the size of relative differences have no particular meaning. Only ranking is "real", since the "level of utility" is \textbf{unobservable} and anything required to know the "level of utility" is \textbf{untestable}.

The central theorem of utility functions is closely linked to rationality:
\begin{theorem}{representable by $u(\cdot)$ $\Rightarrow$ rational $\succsim$}{utility_is_rational}
    A preference relation $\succsim$ can be represented by a utility function $\Rightarrow$ $\succsim$ is rational
\end{theorem}

The proof is
\begin{enumerate}
    \item[-] \textit{Completeness}. Since $u(\cdot)$ represents preference relations between alternatives, and $u:X\rightarrow\mathbb{R}$, thus $\forall x,y\in X$, either $u(x)\geq u(y)$ or $u(y) \geq u(x)$. By Def.\ref{def:utility}, we have either $x\succsim y$ or $y\succsim x$, hence $\succsim$ is complete.
    \item[-] \textit{Transitivity}. For $x\succsim y,y\succsim z$. By Def.\ref{def:utility}, $u(x)\geq u(y),u(y)\geq u(z)$, hence $u(x)\geq u(z)\Rightarrow x\succsim z$.
\end{enumerate}

What about the other way? It is true, subject to some prerequisites:
\begin{theorem}{rational $\succsim$ $\Rightarrow$ representable by $u(\cdot)$ (finite)}{rational_has_utility}
    $\succsim$ is rational and $X$ is \textbf{finite} $\Rightarrow$ there is a utility function representing $\succsim$.
\end{theorem}

The major prerequisite here is $X$ being \textbf{finite}. The proof is done by induction: Suppose there are $N$ elements in $X$:
\begin{enumerate}
    \item[-] When $N=1$, any number could be assigned to that element as its utility.
    \item[-] Suppose a rational $\succsim$ on $X={x_1,x_2,\cdots,x_{N-1}}$ could be represented by a utility function $u(\cdot)$. Without losing generality, we can assume $u(x_1)\leq u(x_2)\leq\cdots\leq u(x_{N-1})$. For the $N$th element $x_N$, by the rationality of $\succsim$, we have three scenarios:
    \begin{enumerate}
        \item[i] $\forall i\in {1,\cdots,N-1}, x_N\succsim x_i$: by Def.\ref{def:utility}, $u(x_N)\geq u(x_i)$.
        \item[ii] $\forall i\in {1,\cdots,N-1}, x_i\succsim x_N$:, $u(x_N)\leq u(x_i)$.
        \item[iii] $\exists i,j\in {1,\cdots,N-1}, i\neq j, x_j \succsim x_N\succsim x_i$: $u(x_j)\geq u(x_N)\geq u(x_i)$. By completeness and transitivity, ${x_1,x_2,\cdots,x_{N-1}}$ can be "divided" by $x_N$, meaning that for $I=\{i:x_N\succsim x_i\}$ and $J=\{j:s_j\succsim x_N\}$, $I\cup J=\{1,\cdots,N-1\}$. Note that we have assumed the index as the ranking, hence let $i^*=\max I,j^*=\min J$, $i^*+1=j^*$, hence we must have $u(x_i)\leq u(x_{i^*})\leq u(x_N)\leq u(x_{j^*})\leq u(x_j)$
    \end{enumerate}
    In all 3 scenarios, $u(\cdot)$ represents $\succsim$ on $X=\{x_1,\cdots,x_{N-1},x_N\}$ as well.
\end{enumerate}
With this induction, we prove Thm.\ref{thm:rational_has_utility}\footnote{Another way of proof is: Start with $x^{start}\in X$, define $W_{x}=\{y:y\prec x^{start}\}$ then $W_x$ is either empty or not: If not empty, pick $\tilde{x}\in W_{x}$, shrink $W_{x}$ to $\{y:y\prec \tilde{x}\}$ and repeat this procedure till $a\sim x^{stop}$ where $u(a)=0$, then $x^{stop}$ is the “lower bound” of the set. With this process, we can generate a utility function for any finite set $X$ that is rational.}.

Now extend Thm.\ref{thm:rational_has_utility} from finite $X$ to countable infinite $X$:
\begin{theorem}{rational $\succsim$ $\Rightarrow$ representable by $u(\cdot)$ (countably infinite)}{rational_has_utility_countable}
    $\succsim$ is rational and $X$ is \textbf{countable} $\Rightarrow$ there is a utility function representing $\succsim$.
\end{theorem}

To prove Thm.\ref{thm:rational_has_utility_countable}, we can construct a utility function: for any set $S$, its emuneration $\{s_1,s_2,\cdots\}$ (which exists if $S$ is countable), define an auxilary function $d:S\rightarrow \mathbb{R}$ as $d(s_i)=\left(\frac{1}{2}\right)^n$, then for a countable set $X=\{x_1,x_2,\cdots\}$, the utility of any element $\tilde{x}\in X$ can be defined as 
$$u(x^*)=\sum_{\tilde{x}_i\in NBT(x^*)}d(\tilde{x}_i)$$\footnote{Notice that $\lim_{n\rightarrow\infty}\sum_{i=1}^n\frac{1}{2^i}=1$, utility is bounded to $[0,1)$.}
where $NBT(x^*)$ is the set of all elements that are \textbf{n}ot \textbf{b}etter \textbf{t}han $x^*$, i.e. $NBT(x^*)=\{\tilde{x}_i:\tilde{x}_i\in X \land x^*\succsim \tilde{x}_i\}$. It is easy to see that $NBT(x^*)$ is a countable subset of $X$. Suppose $NBT(x^*)$ has $k$ elements ($k<n$), we can calculate the utility $u(x^*)=\sum_{i=1}^k\left(\frac{1}{2}\right)^i$. After this construction,
rest of the proof is trivial: $\forall x,y\in X$, $x\succsim y\Rightarrow NBT(x)\supseteq NBT(y)$, which means that $NBT(x)$ has at least as many elements as $NBT(y)$, by the constructed utility function, it is easy to see $u(x)\geq u(y)$; Conversely, $u(x)\geq u(y)$ simply means that $NBT(x)$ contains at least as many elements as $NBT(y)$ does, which directly leads to $x\succsim y$.

Now, let's figure out the difficult question: what about uncountable sets? Here is a very general proposition:
\begin{theorem}{rational $\succsim$ $\Rightarrow$ representable by $u(\cdot)$ (infinite)}{rational_utility_incountable}
    For a rational preference $\succsim$ on a set $X$, $\succsim$ can be represented by $u(\cdot)$ if and only if some countable set $X^*$ of $X$ has the property that $\forall x,y\in X, x\succ y\Rightarrow \exists x^*\in X^*$ s.t. $x\succsim x^*\succ y$.
\end{theorem}
The proof of Thm.\ref{thm:rational_utility_incountable} is not that difficult:
\begin{enumerate}
    \item[Step 1:] such $X^*$ exists $\Rightarrow$ rational $\succsim$ can be represented by $u(\cdot)$.
    \begin{enumerate}
        \item[-]Given such $X^*$, $x\succsim y\Rightarrow u(x)\geq u(y)$
        
        Suppose $X^*$ exists, let it be $X^*=\{x_1^*,x_2^*,\cdots\}$. Again, define $d(x_n^*)=\frac{1}{2^n}$, we can then construct a utility function as 
        $$\forall x\in X, u(x)=\sum_{\tilde{x}_i^*\in X^*\cap NBT(x)}d(\tilde{x}^*_i)$$
        Since $x\succsim y\Leftrightarrow NBT(x)\supseteq NBT(y)$, hence $NBT(x)\cap X^*\supseteq NBT(y)\cap X^*$, which, by the construction of $\sum\frac{1}{2^n}$, leading to $u(x)\geq u(y)$.

        \item[-] Given such $X^*$, $u(x)\geq u(y)\Rightarrow x\succsim y$
        
        We can prove the contrapositive: $ y\not\succsim x\Rightarrow u(y)\not\geq u(x)$. Given the rationality of $\succsim$, $y\not\succsim x \Rightarrow x\succ y$, then $\exists x^*\in X^*$ s.t. $x\succsim x^* \succ y$, hence we know $NBT(x)$ is strictly larger then $NBT(y)$ ($NBT(x)$ includes $x^*$), therefore, by definition, $u(x)>u(y)\Rightarrow u(y)\not\geq u(x)$.
    \end{enumerate}
    
    \item[Step 2:] rational $\succsim$ can be represented by $u(\cdot)$ $\Rightarrow$ such $X^*$ exists.
    
    We want to prove this, but it is very difficult to prove in general, so we construct a special case: Let $\{I_n\}$ be a set of all closed intervals with rational endpoints, that is, each $I_n$ is an interval of $[\underline{q}_n,\bar{q}_n]$ where $\bar{q}_n>\underline{q}_n$ are rational numbers.
    The set of rational numbers is countable, the cross product of two countable sets is also countable, hence $\{I_n\}$ is countable as well. Let $u(X)$ denote the set of real numbers $\{r\in \mathbb{R}: \exists x\in X, r=u(x)\}$, there will be 3 possible scenarios:
    \begin{enumerate}
        \item[i.] $u(X)\cap I_n\neq \varnothing$: for each $I_n$, pick one $x\in X$ s.t. $u(x)\in I_n$ and name it $x_n$
        \item[ii.] $u(X)\cap I_n =\varnothing$: let $\bar{r}_n=\inf \{r\in u(X):r>\bar{q}_n\}$. If $\exists x\in X$ s.t. $u(x)=\bar{r}_n$, choose one such $x$ and name it $x_n$
        \item[iii.] $u(X)\cap I_n=\varnothing\land \forall x\in X, \bar{r}_n\neq u(x)$, no $x$ will be defined as $x_n$
    \end{enumerate}
    If we define $X^*$ as the collection of all $x_n$ in case i) and ii). Notice there is less than one $x_n$ for each $I_n$ and $I_n$ is countable, hence $X^*$ is countable as well.

    Suppose $x\succ y$ for $x,y\in X$, we have $u(\cdot)$ representing $\succsim$, hence $u(x)>u(y)$. Choose some rational number $q$ in the open interval $(u(y),u(x))$ and let $\bar{r}=\inf \{r\in u(X):r>q\}$. Given this setup, we have $u(x)\geq \bar{r}$ since $u(x)>q$. If:
    \begin{enumerate}
        \item[-] $u(x)>\bar{r}$: we can always find a rational number $q'$ s.t. $u(x)>q'>\bar{r}$. Let $n$ be the index of the interval $[q,q']$, since $q<\bar{r}<q'$, $\bar{r}\in u(X)\cap[q,q']\Rightarrow u(X)\cap[q,q']\neq \varnothing$. Therefore, $\exists x^*\in X^*$, namely $x_n$, s.t. $u(x^*)\in [q,q']$, leading to $u(x)\succ u(x^*)\succ u(y)$.
        \item[-] $u(x)=\bar{r}$: we can always find a rational number $q'$ s.t. $q>q'>u(y)$. Let $n$ be the index of the interval $[q,q']$. If $u(X)\cap [q',q]\neq \varnothing$, then $\exists x^*\in X^*$ s.t. $u(x)\geq q\geq u(x^)\geq q'\geq u(y)$, then $x\succsim x^*\succ y$. If $u(X)\cap [q,q']=\varnothing$, then $[q,q']$ fits into category (ii) above, and $\exists x^*\in X^*$, namely $x_n$, such that $u(x^*)=\bar{r}=u(x)$. With this $x^*$, we have $u(x^*)=u(x)>u(y)\Rightarrow x\succsim x^*\succ y$.
    \end{enumerate}
\end{enumerate}

This is a very smart proof, and it is very general as well. However, you would have to make sure that the countable seubset $X^*$ exists, which is not very practical. This problem leads to topological $\succsim$, which will be covered later.

It is natural that if we start from $\succ$, we would have the same logic \citep[See][Page 30]{kreps1990acourse}:

\begin{enumerate}
    \item[-] similar definition: $x\succ y\Leftrightarrow u(x)>u(y)$
    \item[-] similar theorems: 
    \begin{enumerate}
        \item[i] $\exists u(\cdot)$ representing $\succ$ $\Rightarrow$ rational $\succ$ (asymmetric and negatively transitive)
        \item[ii] If $X$ is finite or at least countably infinite, $\exists u(\cdot)$ representing $\succ$ $\Leftrightarrow$ rational $\succ$
    \end{enumerate} 
\end{enumerate}